<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>문살살 CCTV</title>
        <style>
            /* Webfont: Noto Sans KR for Korean text rendering */
            @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap");

            body {
                background-color: #1a1a1a;
                color: #ffffff;
                font-family: "Noto Sans KR", Arial, sans-serif;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100vh;
                margin: 0;
            }
            .container {
                background-color: #2d2d2d;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
                text-align: center;
                width: 700px;
            }
            h1 {
                font-weight: 300;
                letter-spacing: 2px;
                margin-bottom: 20px;
                font-size: 28px;
            }
            .video-box {
                width: 640px;
                height: 480px;
                background-color: #000;
                margin: 0 auto;
                border: 2px solid #444;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }
            .video-box img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .waveform-box {
                width: 640px;
                height: 100px;
                background-color: #000;
                margin: 10px auto 0;
                border: 2px solid #444;
                border-radius: 5px;
                overflow: hidden;
            }
            #waveform-canvas {
                display: block;
                width: 100%;
                height: 100%;
            }
            .status-bar {
                background-color: #222;
                padding: 10px;
                margin-top: 10px;
                border-radius: 5px;
                font-size: 1.2em;
                color: #aaa;
            }
            .controls {
                margin-top: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 15px;
            }
            .power-btn {
                background: none;
                border: none;
                cursor: pointer;
                color: #555;
                transition: color 0.3s;
            }
            .power-btn.on {
                color: #00ff00; /* Green glow */
                text-shadow: 0 0 10px #00ff00;
            }
            .power-btn svg {
                width: 60px;
                height: 60px;
                fill: currentColor;
            }
            .label {
                font-size: 0.9em;
                color: #888;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>문살살</h1>

            <div class="video-box">
                <img src="/video_feed" alt="CCTV Feed" />
            </div>

            <div class="waveform-box">
                <canvas id="waveform-canvas" width="640" height="100"></canvas>
            </div>

            <div class="status-bar" id="db-display">현재 소음: 0 dB</div>

            <div class="controls">
                <span class="label">POWER</span>
                <button
                    class="power-btn on"
                    id="power-btn"
                    onclick="togglePower()"
                >
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.41L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"
                        />
                    </svg>
                </button>
                <span class="label">ON OFF</span>
            </div>
        </div>

        <script>
            const canvas = document.getElementById("waveform-canvas");
            const ctx = canvas.getContext("2d");
            const width = canvas.width;
            const height = canvas.height;

            function drawWaveform(waveformData) {
                // Clear canvas
                ctx.fillStyle = "#000";
                ctx.fillRect(0, 0, width, height);

                if (!waveformData || waveformData.length === 0) {
                    return;
                }

                // Create gradient
                const gradient = ctx.createLinearGradient(0, 0, 0, height);
                gradient.addColorStop(0, "#0080ff");
                gradient.addColorStop(0.5, "#00d4ff");
                gradient.addColorStop(1, "#0080ff");

                ctx.strokeStyle = gradient;
                ctx.lineWidth = 2;
                ctx.beginPath();

                const step = width / waveformData.length;
                const midY = height / 2;
                const scale = height / 65536; // int16 range

                for (let i = 0; i < waveformData.length; i++) {
                    const x = i * step;
                    const y = midY - waveformData[i] * scale * midY;

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }

                ctx.stroke();
            }

            function updateWaveform() {
                fetch("/audio_waveform")
                    .then((response) => response.json())
                    .then((data) => {
                        drawWaveform(data.waveform);
                    })
                    .catch((err) => console.error("Waveform error:", err));
            }

            function updateStatus() {
                fetch("/status")
                    .then((response) => response.json())
                    .then((data) => {
                        document.getElementById(
                            "db-display"
                        ).innerText = `현재 소음: ${data.db} dB`;
                        const btn = document.getElementById("power-btn");
                        if (data.is_running) {
                            btn.classList.add("on");
                        } else {
                            btn.classList.remove("on");
                        }
                    });
            }

            function togglePower() {
                fetch("/toggle_power", { method: "POST" })
                    .then((response) => response.json())
                    .then((data) => {
                        console.log("Power toggled:", data.status);
                        updateStatus();
                    });
            }

            setInterval(updateStatus, 1000);
            setInterval(updateWaveform, 100); // Update waveform 10x per second
        </script>
    </body>
</html>
